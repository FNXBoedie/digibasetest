<!DOCTYPE html>
<html lang="nl-BE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiBase - Digipunt Assistent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #121212;
            --surface: #1e1e1e;
            --surface-variant: #252525;
            --primary: #50A0E0; 
            --primary-variant: #408CCA; 
            --secondary: #70B4F0; 
            --text-primary: #e1e1e1;
            --text-secondary: #b0b0b0;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            --user-message: var(--primary); 
            --bot-message: #2d2d2d;
            --container-width: 1000px;
            --border-radius: 16px;
            --input-radius: 24px;
            --popup-width: 400px; /* Breedte voor de pop-ups */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden; /* Voorkom horizontale scrollbars door popups */
        }

        #appHeader {
            text-align: center;
            margin-bottom: 24px;
            width: 100%;
            max-width: var(--container-width);
            position: relative; /* Voor positionering helpknop */
        }

        #appHeader h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        #appHeader p {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* --- NIEUW: Help Knop en Menu --- */
        #helpSection {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 100;
        }

        #helpButton {
            background-color: var(--surface-variant);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #helpButton:hover {
            background-color: var(--primary);
            color: white;
        }
        #helpButton svg {
            width: 20px;
            height: 20px;
        }

        #helpMenu {
            display: none; /* Initieel verborgen */
            position: absolute;
            top: 48px; /* Onder de help knop */
            right: 0;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 8px;
            z-index: 101;
            min-width: 180px;
        }
        #helpMenu button {
            display: block;
            width: 100%;
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 10px 12px;
            text-align: left;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        #helpMenu button:hover {
            background-color: var(--surface-variant);
        }


        #chatContainer {
            width: 100%;
            max-width: var(--container-width);
            height: 75vh;
            max-height: 700px;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }

        #fileLoadSection {
            padding: 16px;
            background-color: rgba(80, 160, 224, 0.08); 
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .status {
            color: var(--secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .warning {
            color: #FF453A;
            font-weight: 600;
        }

        #chatbox {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        #chatbox::-webkit-scrollbar {
            width: 6px;
        }
        #chatbox::-webkit-scrollbar-track {
            background: transparent;
        }
        #chatbox::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        #chatbox::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user {
            background-color: var(--user-message);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot {
            background-color: var(--bot-message);
            color: var(--text-primary);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .bot.thinking {
            background-color: rgba(45, 45, 45, 0.7);
            position: relative;
            overflow: hidden;
        }
        .bot.thinking::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 50%;
            background: linear-gradient(90deg, transparent, var(--secondary), transparent);
            animation: loadingBar 1.5s infinite;
        }
        @keyframes loadingBar {
            0% { left: -50%; }
            100% { left: 100%; }
        }

        #chatInputSection {
            padding: 16px 20px;
            background-color: var(--surface-variant);
            display: flex; 
            align-items: center;
            border-top: 1px solid var(--border);
        }

        #userInput {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: var(--input-radius);
            font-size: 15px;
            outline: none;
            transition: background-color 0.2s ease;
            box-shadow: 0 0 0 2px rgba(80, 160, 224, 0.4); 
        }
        #userInput::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        #userInput:focus {
            background-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 2px rgba(80, 160, 224, 0.6); 
        }

        #sendButton {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-left: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(80, 160, 224, 0.3); 
        }
        #sendButton:hover {
            background-color: var(--primary-variant);
            transform: scale(1.05);
        }
        #sendButton:active {
            transform: scale(0.95);
        }

        .powered-by {
            margin-top: 14px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            opacity: 0.7;
        }

        /* --- NIEUW: Popup Styles --- */
        .popup-overlay { /* Optioneel: voor een achtergrond-dim */
            display: none; /* Initieel verborgen */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .popup {
            display: none; /* Initieel verborgen */
            position: fixed;
            top: 50%;
            left: calc(20px + (var(--popup-width) / 2)); /* Links van de pagina, gecentreerd op zijn eigen breedte */
            transform: translate(-50%, -50%);
            width: var(--popup-width);
            max-height: 80vh;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            animation: slideInFromLeft 0.3s ease-out;
        }

        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translate(-70%, -50%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .popup-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }
        .popup-close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .popup-close-button:hover {
            color: var(--text-primary);
        }

        .popup-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        /* Styling voor handleiding content */
        .popup-content h2, .popup-content h3 {
            color: var(--secondary);
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .popup-content h2:first-child, .popup-content h3:first-child {
            margin-top: 0;
        }
        .popup-content p, .popup-content li {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 0.75em;
        }
        .popup-content ul, .popup-content ol {
            margin-left: 20px;
            margin-bottom: 1em;
        }
        .popup-content blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 15px;
            margin: 1em 0;
            font-style: italic;
            color: var(--text-secondary);
        }
        .popup-content blockquote p {
            margin-bottom: 0.5em;
        }

        /* Styling voor voorbeeldvragen knoppen */
        .example-question-button {
            display: block;
            width: 100%;
            background-color: var(--surface-variant);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .example-question-button:hover {
            background-color: var(--primary);
            border-color: var(--primary-variant);
            color: white;
        }
        .example-question-button:last-child {
            margin-bottom: 0;
        }


        @media (max-width: 768px) {
            #chatContainer {
                height: 80vh;
            }
            .message {
                max-width: 90%;
            }
            /* Popup aanpassingen voor kleinere schermen */
            .popup {
                width: 90vw; /* Maak popup breder op mobiel */
                left: 50%; /* Centreer op het scherm */
                transform: translate(-50%, -50%);
            }
             @keyframes slideInFromLeft { /* Pas animatie aan voor gecentreerde popup */
                from { opacity: 0; transform: translate(-50%, -40%); }
                to { opacity: 1; transform: translate(-50%, -50%); }
            }
            #helpSection {
                position: static; /* Zet help knop terug in flow */
                margin-bottom: 10px;
                text-align: right;
            }
            #helpMenu {
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                top: auto; /* Relatief aan helpSection */
            }
        }

        @media (max-width: 480px) {
            #appHeader h1 {
                font-size: 28px;
            }
            #chatContainer {
                height: calc(100vh - 180px); /* Meer ruimte voor chat op zeer kleine schermen */
            }
            #chatInputSection {
                padding: 12px;
            }
            #userInput {
                padding: 12px 16px;
            }
            #sendButton {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>

<div id="appHeader">
    <h1>DigiBase Json met handleiding</h1>
    <p>Uw interne virtuele assistent van Digipunt</p>
    <!-- NIEUW: Help Sectie -->
    <div id="helpSection">
        <button id="helpButton" aria-label="Help en opties">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 16.0002V12.0002M12 8.00024H12.01M21 12.0002C21 16.9708 16.9706 21.0002 12 21.0002C7.02944 21.0002 3 16.9708 3 12.0002C3 7.02966 7.02944 3.00024 12 3.00024C16.9706 3.00024 21 7.02966 21 12.0002Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <div id="helpMenu">
            <button id="manualButton">Handleiding</button>
            <button id="exampleQuestionsButton">Voorbeeldvragen</button>
        </div>
    </div>
</div>

<div id="chatContainer">
    <div id="fileLoadSection">
        <p class="status" id="loadStatus">Bezig met laden van bedrijfsgegevens...</p>
    </div>
    <div id="chatbox"></div>
    <div id="chatInputSection">
        <input type="text" id="userInput" placeholder="Stel uw vraag aan Digipunt...">
        <button id="sendButton" onclick="sendMessage()" aria-label="Verstuur bericht">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
</div>

<div class="powered-by">Powered by Gemini AI</div>

<!-- NIEUW: Pop-up containers -->
<div class="popup-overlay" id="popupOverlay"></div>

<div class="popup" id="manualPopup">
    <div class="popup-header">
        <h2>Handleiding</h2>
        <button class="popup-close-button" id="closeManualButton" aria-label="Sluit handleiding">×</button>
    </div>
    <div class="popup-content" id="manualContent">
        <!-- Handleiding wordt hier geladen -->
        <p>Bezig met laden van handleiding...</p>
    </div>
</div>

<div class="popup" id="examplePopup">
    <div class="popup-header">
        <h2>Voorbeeldvragen</h2>
        <button class="popup-close-button" id="closeExampleButton" aria-label="Sluit voorbeeldvragen">×</button>
    </div>
    <div class="popup-content" id="exampleQuestionsContent">
        <!-- Voorbeeldvraag knoppen worden hier gegenereerd -->
    </div>
</div>


<script>
    // --- CONFIGURATIE ---
    const GEMINI_API_KEY = "AIzaSyAkeZNQdyOcf27Wo9D75ydwELGC2XeM_eU"; 
    const DATA_FILE_URL = 'data.json'; 
    const MANUAL_FILE_URL = 'handleiding.html'; // << NIEUW
    const MAX_HISTORY_TURNS = 5;

    // --- GLOBALE VARIABELEN ---
    let infoChunks = [];
    let conversationHistory = [];
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const loadStatus = document.getElementById('loadStatus');
    const fileLoadSection = document.getElementById('fileLoadSection');
    const chatInputSection = document.getElementById('chatInputSection');

    // --- NIEUW: DOM Elementen voor Help & Popups ---
    const helpButton = document.getElementById('helpButton');
    const helpMenu = document.getElementById('helpMenu');
    const manualButton = document.getElementById('manualButton');
    const exampleQuestionsButton = document.getElementById('exampleQuestionsButton');
    
    const popupOverlay = document.getElementById('popupOverlay');
    const manualPopup = document.getElementById('manualPopup');
    const examplePopup = document.getElementById('examplePopup');
    const closeManualButton = document.getElementById('closeManualButton');
    const closeExampleButton = document.getElementById('closeExampleButton');
    const manualContent = document.getElementById('manualContent');
    const exampleQuestionsContent = document.getElementById('exampleQuestionsContent');

    const exampleQuestions = [
        "Wat is Digipunt?",
        "Hoe kan ik Geert Deruyck contacteren?",
        "Wie is de arbeidsbegeleider en wat is hun gegevens?",
        "Geef me informatie over Bart Peeters.",
        "Wanneer is de Vlaamse Kaai open?",
        "Ik wil AMAL bezoeken en heb tijd op woensdag en zaterdag.",
        "Hoe heet dat Digipunt in een café ook alweer?",
        "Wie heeft er allemaal een laptop van d09?"
    ];


    // --- DATA LAAD LOGICA (van URL) ---
    async function loadDataFromUrl() {
        loadStatus.textContent = `Bezig met ophalen van data...`;
        chatInputSection.style.display = 'flex';

        try {
            const response = await fetch(DATA_FILE_URL);
            if (!response.ok) {
                 loadStatus.innerHTML = `<span class="warning">Fout: Kon data niet ophalen van ${DATA_FILE_URL}. Status: ${response.status}</span>`;
                 return;
            }
            const jsonData = await response.json(); 
            processCompanyInfo(jsonData);

            loadStatus.textContent = `Data succesvol geladen. De assistent is klaar!`;
            setTimeout(() => {
                fileLoadSection.style.display = 'none';
                const initialBotMessage = "Hallo! Ik ben de virtuele assistent van Digipunt. Hoe kan ik u vandaag helpen?";
                addMessageToChat(initialBotMessage, 'bot');
                userInput.focus();
            }, 1500);

        } catch (error) {
            if (error instanceof SyntaxError) { 
                 loadStatus.innerHTML = `<span class="warning">Fout: De data in ${DATA_FILE_URL} is geen geldige JSON. Controleer het bestand. (${error.message})</span>`;
            } else {
                 loadStatus.innerHTML = `<span class="warning">Fout bij ophalen data: ${error.message}</span>`;
            }
            console.error("Fetch/Parse error:", error);
        }
    }

    // --- DATA VERWERKING ---
    function processCompanyInfo(jsonData) {
        if (Array.isArray(jsonData) && jsonData.every(item => typeof item === 'object' && item !== null && typeof item.content === 'string')) {
            infoChunks = jsonData.map(item => item.content.trim()).filter(chunk => chunk.length > 0);
        } else {
            if (Array.isArray(jsonData) && jsonData.every(item => typeof item === 'string')) {
                console.warn("JSON data is een array van strings. Aanbevolen formaat is een array van objecten met een 'content' property.");
                infoChunks = jsonData.map(chunk => chunk.trim()).filter(chunk => chunk.length > 0);
            } else {
                console.error("Ongeldig JSON-formaat in processCompanyInfo.");
                loadStatus.innerHTML = `<span class="warning">Fout: Ongeldige structuur in het databestand.</span>`;
                infoChunks = []; 
            }
        }
    }

    // --- CHATBOT LOGICA ---
    function findRelevantChunks(query) {
        if (infoChunks.length === 0) return "";
        const queryWords = query.toLowerCase().split(/\s+/).filter(word => word.length > 2 && !["de", "het", "een", "is", "wie", "wat", "waar", "zijn", "ik", "u", "van", "voor"].includes(word));
        let relevantChunksWithScores = [];
        infoChunks.forEach((chunk) => {
            let score = 0;
            const lowerChunk = chunk.toLowerCase();
            queryWords.forEach(word => {
                if (lowerChunk.includes(word)) score++;
            });
            if (score > 0) relevantChunksWithScores.push({ chunk: chunk, score: score });
        });
        relevantChunksWithScores.sort((a, b) => b.score - a.score);
        return relevantChunksWithScores.slice(0, 6).map(item => item.chunk).join("\n\n---\n\n");
    }

    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;
        if (infoChunks.length === 0 && !GEMINI_API_KEY.startsWith("AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU") && GEMINI_API_KEY !== "YOUR_GEMINI_API_KEY_HERE") {
            addMessageToChat("De bedrijfsdata is nog niet geladen.", 'bot');
            return;
        }

        addMessageToChat(query, 'user');
        userInput.value = '';
        const thinkingMsgId = 'thinking-message-' + Date.now();
        addMessageToChat("Even aan het nadenken...", 'bot', thinkingMsgId, true); 

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || GEMINI_API_KEY.startsWith("AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU")) {
            removeMessageById(thinkingMsgId);
            addMessageToChat("FOUT: Gemini API Key niet correct geconfigureerd.", 'bot');
            return;
        }
        
        const context = findRelevantChunks(query);
        let currentConversationContents = [];
        const historyForGemini = conversationHistory.map(turn => ({
            role: turn.sender === 'user' ? 'user' : 'model',
            parts: [{ text: turn.text }]
        }));
        currentConversationContents = [...historyForGemini, { role: 'user', parts: [{ text: query }] }];

        const systemInstruction = `
Je bent een behulpzame en vriendelijke virtuele assistent voor Digipunt, een organisatie in België.
Je spreekt altijd in het Nederlands (Vlaams).
Beantwoord de vraag van de gebruiker UITSLUITEND op basis van de hieronder volgende "CONTEXT VAN BEDRIJFSINFORMATIE" indien deze relevant is voor de HUIDIGE vraag van de gebruiker.
Gebruik ook de voorgaande conversatie voor context indien nodig om follow-up vragen te begrijpen.
STIJLREGELS VOOR ANTWOORDEN:
1.  **Standaard Antwoord (meeste vragen):** Wees direct, kort en bondig. Ga direct naar de kern van de zaak.
2.  **Follow-up/Verduidelijking:** Als de HUIDIGE vraag een duidelijke follow-up is, mag je een iets meer conversationele toon aannemen.
3.  **Geen Informatie:** Als de informatie niet aanwezig is in de "CONTEXT VAN BEDRIJFSINFORMATIE", geef aan: "Die specifieke informatie heb ik niet kunnen vinden in de documenten."
4.  **Algemeen:** Speculeer niet. Wees professioneel. Gebruik "wij" of "Digipunt".
BELANGRIJK VOOR CONTEXTGEBRUIK:
- Analyseer datums (DD-MM-YYYY) zorgvuldig voor vergelijkingen.
- Presenteer lijsten als de context dit bevat.
CONTEXT VAN BEDRIJFSINFORMATIE (gebruik dit voor de HUIDIGE vraag van de gebruiker):
--- START VAN CONTEXT ---
${context || "Er werd geen specifieke context gevonden in de documenten voor deze vraag."}
--- EINDE VAN CONTEXT ---
`;
        try {
            const requestBody = {
                contents: currentConversationContents,
                system_instruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {}
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            removeMessageById(thinkingMsgId);

            if (!response.ok) {
                const errorData = await response.json();
                let errorMessage = `Fout: ${response.status}. API Bericht: ${errorData?.error?.message || 'Onbekende API fout'}`;
                addMessageToChat(errorMessage, 'bot');
                return;
            }
            const data = await response.json();
            if (data.candidates?.[0]?.finishReason && data.candidates[0].finishReason !== "STOP" && data.candidates[0].finishReason !== "MAX_TOKENS") {
                addMessageToChat(`Antwoord generatie gestopt. Reden: ${data.candidates[0].finishReason}.`, 'bot');
                return;
            }
            if (data.promptFeedback?.blockReason) {
                addMessageToChat(`Vraag geblokkeerd. Reden: ${data.promptFeedback.blockReason}. Probeer anders te formuleren.`, 'bot');
                return;
            }
            if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                addMessageToChat("Onverwacht API-antwoord.", 'bot');
                return;
            }
            addMessageToChat(data.candidates[0].content.parts[0].text.trim(), 'bot');
        } catch (error) {
            removeMessageById(thinkingMsgId);
            addMessageToChat(`Netwerk/Fetch Fout: ${error.message}`, 'bot');
        }
    }

    // --- HULPFUNCTIES ---
    function addMessageToChat(text, sender, id = null, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);
        if (isThinking) messageDiv.classList.add('thinking');
        messageDiv.textContent = text; 
        if (id) messageDiv.id = id;
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        if (!isThinking) {
            conversationHistory.push({ sender: sender, text: text });
            if (conversationHistory.length > MAX_HISTORY_TURNS * 2) {
                conversationHistory.splice(0, conversationHistory.length - (MAX_HISTORY_TURNS * 2));
            }
        }
    }

    function removeMessageById(id) {
        const msg = document.getElementById(id);
        if (msg) msg.remove();
    }
    
    // --- NIEUW: Popup en Help Menu Logica ---
    function openPopup(popupElement) {
        popupOverlay.style.display = 'block';
        popupElement.style.display = 'flex'; // Omdat popup een flex container is
        // Sluit het help menu als een popup opent
        helpMenu.style.display = 'none';
    }

    function closePopup(popupElement) {
        popupOverlay.style.display = 'none';
        popupElement.style.display = 'none';
    }

    async function loadManual() {
        try {
            const response = await fetch(MANUAL_FILE_URL);
            if (!response.ok) {
                manualContent.innerHTML = `<p class="warning">Fout: Kon handleiding niet laden. (Status: ${response.status})</p>`;
                return;
            }
            const htmlContent = await response.text();
            manualContent.innerHTML = htmlContent;
        } catch (error) {
            manualContent.innerHTML = `<p class="warning">Fout bij laden handleiding: ${error.message}</p>`;
            console.error("Error loading manual:", error);
        }
    }

    function populateExampleQuestions() {
        exampleQuestionsContent.innerHTML = ''; // Leegmaken voor het geval het opnieuw wordt aangeroepen
        exampleQuestions.forEach(questionText => {
            const button = document.createElement('button');
            button.classList.add('example-question-button');
            button.textContent = questionText;
            button.onclick = () => {
                userInput.value = questionText;
                sendMessage();
                closePopup(examplePopup);
            };
            exampleQuestionsContent.appendChild(button);
        });
    }

    // Event Listeners voor Help en Popups
    helpButton.addEventListener('click', (event) => {
        event.stopPropagation(); // Voorkom dat klikken op de knop direct body-listener triggert
        helpMenu.style.display = helpMenu.style.display === 'block' ? 'none' : 'block';
    });

    // Klik buiten het menu sluit het menu
    document.addEventListener('click', (event) => {
        if (!helpMenu.contains(event.target) && event.target !== helpButton) {
            helpMenu.style.display = 'none';
        }
    });

    manualButton.addEventListener('click', () => {
        openPopup(manualPopup);
        loadManual(); // Laad de handleiding als de popup opent
    });

    exampleQuestionsButton.addEventListener('click', () => {
        openPopup(examplePopup);
        populateExampleQuestions(); // Genereer knoppen als de popup opent
    });

    closeManualButton.addEventListener('click', () => closePopup(manualPopup));
    closeExampleButton.addEventListener('click', () => closePopup(examplePopup));
    popupOverlay.addEventListener('click', () => { // Klik op overlay sluit actieve popup
        closePopup(manualPopup);
        closePopup(examplePopup);
    });


    // --- EVENT LISTENERS ---
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // --- INITIALISATIE ---
    window.onload = () => {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || GEMINI_API_KEY.startsWith("AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU")) {
            loadStatus.innerHTML = `Welkom! <span class="warning">Configureer a.u.b. uw Gemini API Key.</span>`;
            chatInputSection.style.display = 'flex'; 
            userInput.placeholder = "API Key niet geconfigureerd...";
            userInput.disabled = true;
            document.getElementById('sendButton').disabled = true;
            helpButton.disabled = true; // Ook helpknop uitschakelen
        } else {
            loadDataFromUrl(); 
        }
    };
</script>

</body>
</html>
